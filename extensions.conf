[from-internal]

exten => _XXX,1,NooP()
exten => _XXX,n,DIAL(PJSIP/${EXTEN})
exten => _XXX,n,Hangup()

include => outbound-otp
;--
[outbound-otp]
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
    same => n,Gosub(otp-check,${EXTEN},1)
    same => n,GotoIf($[${GOSUB_RETVAL} = SUCCESS]?dial:failed)
    same => n(dial),Dial(PJSIP/${DESTINATION}@your-trunk,60,tT)
    same => n,Hangup()
    same => n(failed),Playback(goodbye)
    same => n,Hangup()
--;

[outbound-otp]
; Main outbound context - requires OTP verification
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
    same => n,Set(DESTINATION=${EXTEN})
    same => n,Set(USERNAME=${CALLERID(num)}) ; Get username from caller ID
    same => n,Gosub(otp-check,s,1(${USERNAME},${DESTINATION}))
    same => n,GotoIf($[${GOSUB_RETVAL} = SUCCESS]?dial:failed)
    same => n(dial),Dial(PJSIP/${DESTINATION}@your-trunk,60,tT)
    same => n,Hangup()
    same => n(failed),Playback(goodbye)
    same => n,Hangup()

[otp-check]
exten => s,1,NoOp(OTP verification for user ${ARG1} calling ${ARG2})
    same => n,Set(USERNAME=${ARG1})
    same => n,Set(DESTINATION=${ARG2})
    same => n,Set(OTP_ATTEMPTS=0)
    same => n,Goto(ask-code,1)

; Ask for OTP code
exten => ask-code,1,Set(OTP_ATTEMPTS=$[${OTP_ATTEMPTS} + 1])
    same => n,GotoIf($[${OTP_ATTEMPTS} > 3]?max-attempts,1)
;    same => n,Playback(please-enter);
;    same => n,Playback(six-digit)
;    same => n,Playback(auth-code)
    same => n,Read(OTP_CODE,please-enter&six-digit&auth-code,6,,3,10)
    same => n,GotoIf($[${LEN(${OTP_CODE})} != 6]?invalid-length,1)
    same => n,Goto(verify-code,1)

; Invalid code length
exten => invalid-length,1,Playback(invalid-code-length)
    same => n,Goto(ask-code,1)

; Verify the OTP code using SHELL function
exten => verify-code,1,NoOp(Verifying code ${OTP_CODE} for user ${USERNAME})
    same => n,Set(SHELL_RESULT=${SHELL(php /etc/asterisk/otp_verify.php ${USERNAME} ${OTP_CODE})})
    same => n,Set(SHELL_STATUS=${SHELL_STATUS})
    same => n,NoOp(Shell result: ${SHELL_RESULT}, Status: ${SHELL_STATUS})
    same => n,GotoIf($[${SHELL_RESULT} = VALID]?success,1:invalid-code,1)

; Success - code is valid
exten => success,1,NoOp(OTP verification successful for ${USERNAME})
    same => n,Playback(auth-success)
    same => n,Return(SUCCESS)

; Invalid code
exten => invalid-code,1,NoOp(Invalid OTP code: ${OTP_CODE})
    same => n,Playback(invalid-code)
    same => n,Playback(try-again)
    same => n,Goto(ask-code,1)

; Maximum attempts reached
exten => max-attempts,1,NoOp(Maximum OTP attempts reached for ${USERNAME})
    same => n,Playback(max-attempts)
    same => n,Playback(goodbye)
    same => n,Return(FAILED)
